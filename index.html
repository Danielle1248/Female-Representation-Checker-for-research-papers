<!DOCTYPE html>
<html>
<head>
    <title>Female Representation Checker</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f6f9;
            text-align: center;
            padding: 50px;
        }

        h2 {
            color: #333;
            margin-bottom: 30px;
        }

        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            border-radius: 8px;
            cursor: pointer;
        }

        button:hover {
            background-color: #45a049;
        }

        input {
            padding: 10px;
            font-size: 16px;
            width: 300px;
            margin-bottom: 20px;
            border-radius: 6px;
            border: 1px solid #ccc;
        }

        canvas {
            margin-top: 30px;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
        }
    </style>
</head>

<body>

<h2>Female Representation in Research Checker</h2>

<input type="file" id="fileInput" accept=".pdf">
<br><br>
<button onclick="checkPaper()">Check</button>

<h3 id="result"></h3>

<canvas id="resultChart"></canvas>

<script>

const REPRESENTATION_THRESHOLD = 45;
let chartInstance = null;

async function extractTextFromPDF(file) {
    const reader = new FileReader();

    return new Promise((resolve, reject) => {
        reader.onload = async function() {
            const typedarray = new Uint8Array(this.result);
            const pdf = await pdfjsLib.getDocument(typedarray).promise;

            let fullText = "";

            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                const pageText = textContent.items.map(item => item.str).join(" ");
                fullText += pageText + " ";
            }

            resolve(fullText.toLowerCase());
        };

        reader.onerror = reject;
        reader.readAsArrayBuffer(file);
    });
}

function extractMethodsSection(text) {
    const match = text.match(/(methodology|methods|procedure)([\s\S]{0,6000})/);
    return match ? match[0] : null;
}

function detectGenderMention(text) {
    return /women|woman|female|females|girls|men|man|male|males|boys/.test(text);
}

function extractTotal(text) {
    let nMatch = text.match(/n\s*=\s*(\d+)/);
    if (nMatch) return parseInt(nMatch[1]);

    let totalMatch = text.match(/(\d+)\s*(participants|subjects|individuals)/);
    if (totalMatch) return parseInt(totalMatch[1]);

    return null;
}

function extractFemaleCount(text) {
    let femaleMatch = text.match(/(\d+)\s*(women|woman|female|females|girls)/);
    if (femaleMatch) return parseInt(femaleMatch[1]);

    return null;
}

function extractFemalePercent(text) {
    let percentMatch = text.match(/(\d+)\s*%\s*(female|women|girls)/);
    if (percentMatch) return parseFloat(percentMatch[1]);

    return null;
}

function analyzeText(text) {

    const total = extractTotal(text);
    const femaleCount = extractFemaleCount(text);
    const directPercent = extractFemalePercent(text);
    const genderMentioned = detectGenderMention(text);

    let femalePercentage = null;

    if (directPercent !== null) {
        femalePercentage = directPercent;
    } 
    else if (total !== null && femaleCount !== null) {
        femalePercentage = (femaleCount / total) * 100;
    }

    return {
        femalePercentage,
        genderMentioned,
        totalParticipants: total,
        femaleCount: femaleCount
    };
}

async function checkPaper() {

    const fileInput = document.getElementById("fileInput");
    const result = document.getElementById("result");

// Reset previous chart
if (chartInstance) {
    chartInstance.destroy();
    chartInstance = null;
}

// Hide chart until needed
document.getElementById("resultChart").style.display = "none";


    if (!fileInput.files.length) {
        result.innerText = "Please upload a PDF file.";
        return;
    }

    result.innerText = "Analyzing paper...";

    const fullText = await extractTextFromPDF(fileInput.files[0]);
    const methodsSection = extractMethodsSection(fullText);

    let analysis = methodsSection ? analyzeText(methodsSection) : null;

    if (!analysis || analysis.femalePercentage === null) {
        analysis = analyzeText(fullText);
    }
    if (analysis.femalePercentage !== null) {

        const percentage = analysis.femalePercentage.toFixed(2);
        const totalParticipants = analysis.totalParticipants;

        let femaleCount;

        if (analysis.femaleCount !== null) {
            femaleCount = analysis.femaleCount;
        } else {
            femaleCount = Math.round((analysis.femalePercentage / 100) * totalParticipants);
        }

        const maleCount = totalParticipants - femaleCount;

document.getElementById("resultChart").style.display = "block";
        renderChart(femaleCount, maleCount);

        const status = analysis.femalePercentage >= REPRESENTATION_THRESHOLD
            ? "Accurate Representation ✅"
            : "Underrepresentation ❌";

        result.innerText =
            "Female Representation: " + percentage + "%\n" +
            status;
    }

    else if (analysis.genderMentioned) {
        result.innerText = "Number of females in study not specified.";
    }

    else {
        result.innerText = "Female representation not specified in this paper.";
    }
}

// -------- RENDER PIE CHART --------
function renderChart(femaleCount, maleCount) {

    const ctx = document.getElementById('resultChart').getContext('2d');
    const total = femaleCount + maleCount;

    if (chartInstance) {
        chartInstance.destroy();
    }

    chartInstance = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: ['Biologically Female', 'Biologically Male'],
            datasets: [{
                data: [femaleCount, maleCount],
                backgroundColor: ['#2196F3', '#F44336']
            }]
        },
        options: {
            plugins: {
                legend: {
                    position: 'bottom'
                },
                datalabels: {
                    formatter: (value) => {
                        let percentage = (value / total * 100).toFixed(1);
                        return percentage + '%';
                    },
                    color: '#fff',
                    font: {
                        weight: 'bold'
                    }
                }
            }
        },
        plugins: [ChartDataLabels]
    });
}

</script>

</body>
</html>
