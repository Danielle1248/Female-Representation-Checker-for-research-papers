<!DOCTYPE html>
<html>
<head>
    <title>Female Representation Analysis Tool</title>

    <!-- PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f6f9;
            margin: 0;
        }

        /* Navigation */
        .navbar {
            background-color: white;
            padding: 15px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
        }

        .nav-links a {
            text-decoration: none;
            margin-left: 25px;
            color: #333;
            font-weight: 500;
        }

        .nav-links a:hover {
            color: #2196F3;
        }

        .active {
            color: #2196F3;
            border-bottom: 2px solid #2196F3;
            padding-bottom: 4px;
        }

        /* Main Layout */
        .hero {
            text-align: center;
            margin-top: 60px;
        }

        .hero h1 {
            margin-bottom: 10px;
        }

        .hero p {
            color: #555;
        }

        .card {
            max-width: 700px;
            margin: 40px auto;
            background-color: white;
            padding: 30px;
            border-radius: 18px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.08);
            text-align: center;
        }

        input {
            padding: 10px;
            font-size: 16px;
            width: 70%;
            margin-bottom: 20px;
            border-radius: 6px;
            border: 1px solid #ccc;
        }

        button {
            background-color: #2196F3;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            border-radius: 8px;
            cursor: pointer;
        }

        button:hover {
            background-color: #1976D2;
        }

        canvas {
    margin-top: 30px;
    max-width: 400px;
    margin-left: auto;
    margin-right: auto;
    display: none;
    filter: drop-shadow(0px 10px 20px rgba(0, 0, 0, 0.15));
}

        #result {
            white-space: pre-line;
        }
    </style>
</head>

<body>

    <div class="navbar">
        <div><strong>The Parity Project</strong></div>
        <div class="nav-links">
            <a href="index.html" class="active">Home</a>
            <a href="about.html">About</a>
            <a href="mission.html">Mission</a>
        </div>
    </div>

    <div class="hero">
        <h1>Gender Bias Analysis Tool</h1>
        <p>Evaluate biological sex representation in academic research papers.</p>
    </div>

    <div class="card">
        <input type="file" id="fileInput" accept=".pdf"><br>
        <button onclick="checkPaper()">Analyze Paper</button>
    </div>

    <div class="card">
        <h3 id="result"></h3>
        <canvas id="resultChart"></canvas>
    </div>

<script>

const REPRESENTATION_THRESHOLD = 45;
let chartInstance = null;
Chart.register(ChartDataLabels);
Chart.register({
    id: 'connectorLine',
    afterDatasetsDraw(chart) {

        const { ctx, chartArea } = chart;
        const dataset = chart.data.datasets[0];
        const meta = chart.getDatasetMeta(0);
        const total = dataset.data.reduce((a, b) => a + b, 0);

        meta.data.forEach((element, index) => {

            const value = dataset.data[index];
            const percentage = (value / total) * 100;

            if (percentage <= 3) {

                // Start from right edge of pie and subtract
                const startX = element.x + element.outerRadius -110;
                
                // Slightly above center (adjust this number if needed)
                const startY = element.y + -60;

                // End of horizontal line (longer to the right)
                const endX = startX + 102.9;
                const endY = startY;

                ctx.save();

                // Draw horizontal line
                ctx.beginPath();
                ctx.moveTo(startX, startY);
                ctx.lineTo(endX, endY);
                ctx.strokeStyle = '#94A3B8';
                ctx.lineWidth = 2;
                ctx.stroke();

                // Draw percentage at end
                ctx.font = 'bold 14px Arial';
                ctx.fillStyle = '#94A3B8';
                ctx.textAlign = 'left';
                ctx.textBaseline = 'middle';

                ctx.fillText(
                    percentage.toFixed(1) + '%',
                    endX + 6,
                    endY
                );

                ctx.restore();
            }
        });
    }
});

// Reset & Analyze
async function checkPaper() {

    const fileInput = document.getElementById("fileInput");
    const result = document.getElementById("result");
    const chartCanvas = document.getElementById("resultChart");

    // Reset previous chart
    if (chartInstance) {
        chartInstance.destroy();
        chartInstance = null;
    }

    chartCanvas.style.display = "none";

    if (!fileInput.files.length) {
        result.innerText = "Please upload a PDF file.";
        return;
    }

    result.innerText = "Analyzing paper...";

    const fullText = await extractTextFromPDF(fileInput.files[0]);
    const analysis = analyzeText(fullText);

    if (analysis.femalePercentage !== null) {

        const percentage = analysis.femalePercentage.toFixed(2);
        const total = analysis.totalParticipants;
        const femaleCount = analysis.femaleCount || Math.round((analysis.femalePercentage / 100) * total);
        const maleCount = total - femaleCount;

        chartCanvas.style.display = "block";
        renderChart(femaleCount, maleCount);

        const status = analysis.femalePercentage >= REPRESENTATION_THRESHOLD
            ? "Accurate Representation"
            : "Underrepresentation";

        result.innerText =
            "Female Representation: " + percentage + "%\n" +
            status;
    }
    else {
        result.innerText = "Female representation not specified in this paper.";
    }
}

// PDF extraction
async function extractTextFromPDF(file) {
    const reader = new FileReader();

    return new Promise((resolve, reject) => {
        reader.onload = async function() {
            const typedarray = new Uint8Array(this.result);
            const pdf = await pdfjsLib.getDocument(typedarray).promise;
            let text = "";

            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const content = await page.getTextContent();
                text += content.items.map(item => item.str).join(" ");
            }

            resolve(text.toLowerCase());
        };

        reader.onerror = reject;
        reader.readAsArrayBuffer(file);
    });
}

// Simple analysis
function analyzeText(text) {

    let percentMatch = text.match(/(\d+)\s*%\s*(female|women|girls)/);
    let totalMatch = text.match(/n\s*=\s*(\d+)/);
    let femaleMatch = text.match(/(\d+)\s*(female|women|girls)/);

    let femalePercentage = null;
    let totalParticipants = null;
    let femaleCount = null;

    if (percentMatch) {
        femalePercentage = parseFloat(percentMatch[1]);
    }

    if (totalMatch) {
        totalParticipants = parseInt(totalMatch[1]);
    }

    if (femaleMatch) {
        femaleCount = parseInt(femaleMatch[1]);
    }

    if (!femalePercentage && totalParticipants && femaleCount) {
        femalePercentage = (femaleCount / totalParticipants) * 100;
    }

    return {
        femalePercentage,
        totalParticipants,
        femaleCount
    };
}

// Chart rendering
function renderChart(femaleCount, maleCount) {

    const ctx = document.getElementById('resultChart').getContext('2d');
    const total = femaleCount + maleCount;

    chartInstance = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: ['Biologically Female', 'Biologically Male'],
            datasets: [{
                data: [femaleCount, maleCount],
                backgroundColor: [
                    '#5B8DBA',
                    '#8FB7DC'
                ],
                borderColor: '#ffffff',
                borderWidth: 3,
                hoverOffset: 8
            }]
        },
        options: {
            responsive: true,
            animation: {
                animateRotate: true,
                animateScale: true,
                duration: 1800,
                easing: 'easeOutQuart'
            },
            plugins: {
                legend: { 
                    position: 'bottom',
                    labels: {
                        color: '#333',
                        font: { size: 14 }
                    }
                },

                datalabels: {

                    formatter: (value, context) => {
    const total = context.dataset.data.reduce((a, b) => a + b, 0);
    const percentage = (value / total) * 100;

    if (percentage <= 3) return null;

    return percentage.toFixed(1) + "%";
},

                    color: (context) => {
                        const value = context.dataset.data[context.dataIndex];
                        const percentage = (value / total) * 100;
                        return percentage <= 3 ? '#1f2937' : '#ffffff';
                    },

                    font: {
                        weight: 'bold',
                        size: 14
                    },

                    anchor: (context) => {
                        const value = context.dataset.data[context.dataIndex];
                        const percentage = (value / total) * 100;
                        return percentage <= 3 ? 'end' : 'center';
                    },

                    align: (context) => {
                        const value = context.dataset.data[context.dataIndex];
                        const percentage = (value / total) * 100;
                        return percentage <= 3 ? 'right' : 'center';
                    },

                    offset: (context) => {
                        const value = context.dataset.data[context.dataIndex];
                        const percentage = (value / total) * 100;
                        return percentage <= 3 ? 45 : 0;
                    },

                    clamp: true
                }
            }
        },

        
    });
}



</script>

</body>
</html>
